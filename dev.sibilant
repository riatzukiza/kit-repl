(namespace dev)

(include "kit/inc/shell")
(import-namespace shell)

(def commit (message) (shell (git add ".") (git commit "-m" ("\""message "\""))))

(def save-patch (message)
  (pipe (load-json "./package.json")
        (.then (=> (json)
                   (print "before" json)
                   (var current-version (.split json.version "."))
                   (print "current version" current-version)
                   (assign (third current-version) (+ 1 (last current-version)))
                   (assign json.version (.join current-version "."))
                   (print "after" json)
                   (save-json "./package.json" json)))

        (.then (=> (pkg)
                   (commit ("patched " pkg.name " to " pkg.version))))))

(def-promised save-json (path d)
  (.write-file (require 'fs) path (.stringify JSON d)
               (=> (e) (if e (fail e) (success d)))))

(def-promised load-json (path)
  (.read-file (require 'fs) path
              (=> (err d) (if err (fail err) (success (.parse JSON d))))))
